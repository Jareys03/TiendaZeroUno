<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Carrito</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="icon" type="image/png" th:href="@{/img/logo.png}"/>

</head>

<body>

<header th:replace="fragments/navbar :: navbar"></header>

<div class="container mt-4">

  <h1 class="mb-4">Carrito de Compra</h1>

  <!-- Mensaje flash -->
  <div th:if="${mensaje}" class="alert alert-success" th:text="${mensaje}"></div>

  <!-- Si no hay productos -->
  <div th:if="${lineas.isEmpty()}">
    <p>No hay productos en el carrito.</p>
    <a href="/productos" class="btn btn-primary">Ver productos</a>
  </div>

  <!-- Tabla del carrito -->
  <div th:if="${!lineas.isEmpty()}">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
      <tr>
        <th>Producto</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Subtotal</th>
        <th></th>
      </tr>
      </thead>

      <tbody>
      <tr th:each="entry : ${lineas}">
        <!-- entry.key = Producto -->
        <!-- entry.value = cantidad -->

        <td th:text="${entry.key.nombre}"></td>

        <td>
          <span th:text="${entry.key.precio} + ' â‚¬'"></span>
        </td>

        <td width="150">
          <form th:action="@{/carrito/actualizar}" method="post"
                class="d-flex form-actualizar-cantidad">
            <input type="hidden" name="productoId" th:value="${entry.key.id}">
            <input type="number" min="1" class="form-control"
                   name="cantidad" th:value="${entry.value}">
          </form>
        </td>


        <td>
          <span th:text="${#numbers.formatDecimal(entry.key.precio * entry.value, 1, 2)} + ' â‚¬'"></span>
        </td>

        <td>
          <a th:href="@{'/carrito/eliminar/' + ${entry.key.id}}"
             class="btn btn-sm btn-danger">Eliminar</a>
        </td>
      </tr>
      </tbody>
    </table>

    <!-- Total -->
    <div class="text-end mb-4">
      <h4>Total:
        <span th:text="${#numbers.formatDecimal(total, 1, 2)} + ' â‚¬'"></span>
      </h4>
    </div>

    <!-- Acciones -->
    <div class="d-flex justify-content-between">
      <a href="/productos" class="btn btn-primary">Seguir comprando</a>

      <div>
        <a href="/carrito/vaciar" class="btn btn-warning me-2">Vaciar carrito</a>

        <!-- ðŸ”¹ ESTE ES EL BOTÃ“N NUEVO -->
        <form th:action="@{/carrito/confirmar}" method="post" class="d-inline">
          <button type="submit" class="btn btn-success">
            Realizar pedido
          </button>
        </form>
        <!-- ðŸ”¹ FIN BOTÃ“N NUEVO -->

      </div>
    </div>
  </div>

</div>

</body>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('form.form-actualizar-cantidad input[name="cantidad"]')
            .forEach(function (input) {
              input.addEventListener('change', function () {
                this.form.submit(); // se manda solo al cambiar la cantidad
              });
            });
  });
</script>

</html>
